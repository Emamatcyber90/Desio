<%inherit file="base.html"/>
<%namespace name="r" file="/require.html"/>
<%namespace name="f" file="/forms.html"/>

<%!
    from desio.model import STATUS_PENDING, STATUS_REJECTED, STATUS_APPROVED
    from desio.model.users import APP_ROLE_ADMIN, APP_ROLE_WRITE, APP_ROLE_READ
    
    roles = [
        {'key': APP_ROLE_READ, 'value': 'Normal User'},
        {'key': APP_ROLE_WRITE, 'value': 'Creator'},
        {'key': APP_ROLE_ADMIN, 'value': 'Admin'}
    ]
%>
<%def name="header()">
    ${parent.header()}
    <style type="text/css">
    #users .user{border: 1px solid #ccc; padding: 10px; margin: 5px 0;}
    </style>
    <script type="text/javascript">
        new Q.UserSettingsPage({
            roleUrl: '${h.api_url('organization', 'set_user_role', organization=c.organization.id)}'
        }).readyrun();
    </script>
</%def>

<h1>${c.title}</h1>

<% url = h.subdomain_url(c.organization.subdomain, controller='organization/auth', action='register') %>
<p>Add new users by having them register at
    <a href="${url}">${url}</a>, then come back here and approve them!</p>

<div id="users">
% for ou in c.users:
    <div class="user" data-user="${ou.user.id}" >
        <div>${ou.user.human_name}</div>
        
        <div class="role ${ou.status == STATUS_PENDING and 'hidden' or ''}">
            % if c.organization.creator == ou.user:
                ${ou.role} and Organization Creator
            % else:
                ${f.dropdown('role', id=None, values=roles, selectedValue=ou.role)}
            % endif
        </div>
        
        % if c.organization.creator != ou.user:
        
            % if ou.status == STATUS_PENDING:
                <div class="actions">
                    <a href="${h.api_url('organization', 'attachment_approval', organization=c.organization.id, u=ou.user.id, status=STATUS_APPROVED)}" class="approve">
                        approve
                    </a>
                    <a href="${h.api_url('organization', 'attachment_approval', organization=c.organization.id, u=ou.user.id, status=STATUS_REJECTED)}" class="remove">
                        reject
                    </a>
                </div>
            % endif
            
            <div class="actions ${ou.status == STATUS_PENDING and 'hidden' or ''}">
                <a href="${h.api_url('organization', 'remove_user', organization=c.organization.id, u=ou.user.id)}" class="remove">
                    remove
                </a>
            </div>
            
        % endif
    </div>
% endfor
</div>


